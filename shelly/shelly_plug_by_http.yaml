zabbix_export:
  version: '7.4'
  template_groups:
    - uuid: 854db6054ead4b88bdb3a1b1d94bfde1
      name: Custom
  templates:
    - uuid: 27702d31cacc48a5b25a4a4aa2fe9362
      template: 'Shelly Plug by HTTP'
      name: 'Shelly Plug by HTTP'
      description: 'See https://github.com/il-katta/zabbix_templates/tree/master/shelly for documentation'
      groups:
        - name: Custom
      items:
        - uuid: 0d40406da7b24ea6b4daf950e10dcf07
          name: 'Host ping'
          type: SIMPLE
          key: 'net.tcp.service[http,,80]'
          valuemap:
            name: 'Service state'
          preprocessing:
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 10m
          tags:
            - tag: component
              value: healt
            - tag: device
              value: shelly
          triggers:
            - uuid: 6c95c9c4f22c4f96a1a0914bacb164a4
              expression: 'last(/Shelly Plug by HTTP/net.tcp.service[http,,80])=0'
              name: 'Host is down'
              priority: AVERAGE
              manual_close: 'YES'
        - uuid: 12fe9bc1820e4313bfee760e30361146
          name: Shelly.CheckForUpdate
          type: HTTP_AGENT
          key: Shelly.CheckForUpdate
          delay: 1h
          history: '0'
          value_type: TEXT
          authtype: DIGEST
          username: '{$SHELLY_USER}'
          password: '{$SHELLY_PASS}'
          preprocessing:
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1d
          url: 'http://{$SHELLY_HOST}/rpc/Shelly.CheckForUpdate'
          headers:
            - name: User-Agent
              value: Zabbix/7.4
          output_format: JSON
          tags:
            - tag: component
              value: switch
            - tag: device
              value: shelly
        - uuid: b1053ee640174f4e9df0a30a52480932
          name: Shelly.GetStatus
          type: HTTP_AGENT
          key: Shelly.GetStatus
          history: '0'
          value_type: TEXT
          authtype: DIGEST
          username: '{$SHELLY_USER}'
          password: '{$SHELLY_PASS}'
          url: 'http://{$SHELLY_HOST}/rpc/Shelly.GetStatus'
          headers:
            - name: User-Agent
              value: Zabbix/7.4
          output_format: JSON
          tags:
            - tag: component
              value: switch
            - tag: device
              value: shelly
        - uuid: 7da482cf27dc4ab1b6c38f0463e26e73
          name: 'MQTT connection state'
          type: DEPENDENT
          key: shelly.mqtt.connected
          description: 'Current state of MQTT connection'
          valuemap:
            name: Boolean
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.body.mqtt.connected
              error_handler: CUSTOM_VALUE
              error_handler_params: 'false'
            - type: STR_REPLACE
              parameters:
                - 'true'
                - '1'
            - type: STR_REPLACE
              parameters:
                - 'false'
                - '0'
          master_item:
            key: Shelly.GetStatus
          tags:
            - tag: device
              value: shelly
          triggers:
            - uuid: bb13dbff13c14fa8a1c955a96996ed69
              expression: '{$SHELLY_MQTT_ENABLED}=1 and last(/Shelly Plug by HTTP/shelly.mqtt.connected)<>1'
              name: 'MQTT connection state anomaly'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: WARNING
              manual_close: 'YES'
              dependencies:
                - name: 'Host is down'
                  expression: 'last(/Shelly Plug by HTTP/net.tcp.service[http,,80])=0'
              tags:
                - tag: device
                  value: shelly
        - uuid: 246ccb13775a43f595a1ced37b107feb
          name: 'Power by minute 1'
          type: DEPENDENT
          key: 'shelly.switch.aenergy.by_minute0[{$SHELLY_SWITCH}]'
          value_type: FLOAT
          units: W
          description: 'Energy consumption in Milliwatt-hours for the last minute'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.body[''{$SHELLY_TYPE}:{$SHELLY_SWITCH_ID}''].aenergy.by_minute[0]'
              error_handler: DISCARD_VALUE
            - type: JAVASCRIPT
              parameters:
                - 'return value/1000'
          master_item:
            key: Shelly.GetStatus
          tags:
            - tag: component
              value: switch
            - tag: device
              value: shelly
        - uuid: 85cf8c2f788e4a50ac72cdcab3da3f7d
          name: 'Power by minute 2'
          type: DEPENDENT
          key: 'shelly.switch.aenergy.by_minute1[{$SHELLY_SWITCH}]'
          value_type: FLOAT
          units: W
          description: 'Energy consumption in Milliwatt-hours for the last 2nd minute'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.body[''{$SHELLY_TYPE}:{$SHELLY_SWITCH_ID}''].aenergy.by_minute[1]'
              error_handler: DISCARD_VALUE
            - type: JAVASCRIPT
              parameters:
                - 'return value/1000'
          master_item:
            key: Shelly.GetStatus
          tags:
            - tag: component
              value: switch
            - tag: device
              value: shelly
        - uuid: 917fad0bf3f24c5b9b03ababbb57166b
          name: 'Power by minute 3'
          type: DEPENDENT
          key: 'shelly.switch.aenergy.by_minute2[{$SHELLY_SWITCH}]'
          value_type: FLOAT
          units: W
          description: 'Energy consumption in Milliwatt-hours for the last 3rd minute'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.body[''{$SHELLY_TYPE}:{$SHELLY_SWITCH_ID}''].aenergy.by_minute[2]'
              error_handler: DISCARD_VALUE
            - type: JAVASCRIPT
              parameters:
                - 'return value/1000'
          master_item:
            key: Shelly.GetStatus
          tags:
            - tag: component
              value: switch
            - tag: device
              value: shelly
        - uuid: 92882313dc0a4fb185fd8de2e36f67e2
          name: 'Total energy'
          type: DEPENDENT
          key: 'shelly.switch.aenergy.total[{$SHELLY_SWITCH}]'
          value_type: FLOAT
          units: Wh
          description: 'Total energy consumed in Watt-hours'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.body[''{$SHELLY_TYPE}:{$SHELLY_SWITCH_ID}''].aenergy.total'
              error_handler: DISCARD_VALUE
          master_item:
            key: Shelly.GetStatus
          tags:
            - tag: component
              value: switch
            - tag: device
              value: shelly
        - uuid: 136a411fd794423191e7cba564dea347
          name: 'Active Power'
          type: DEPENDENT
          key: 'shelly.switch.apower[{$SHELLY_SWITCH}]'
          value_type: FLOAT
          units: Watt
          description: 'Last measured instantaneous active power (in Watts) delivered to the attached load'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.body[''{$SHELLY_TYPE}:{$SHELLY_SWITCH_ID}''].apower'
              error_handler: DISCARD_VALUE
          master_item:
            key: Shelly.GetStatus
          tags:
            - tag: component
              value: switch
            - tag: device
              value: shelly
        - uuid: bd9339858dcd46a68c40ea3c02bcd28e
          name: Current
          type: DEPENDENT
          key: 'shelly.switch.current[{$SHELLY_SWITCH}]'
          value_type: FLOAT
          units: A
          description: 'Last measured current in Amperes'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.body[''{$SHELLY_TYPE}:{$SHELLY_SWITCH_ID}''].current'
              error_handler: DISCARD_VALUE
          master_item:
            key: Shelly.GetStatus
          tags:
            - tag: component
              value: switch
            - tag: device
              value: shelly
        - uuid: f81ce2b4335245f68356e51643def916
          name: Power
          type: DEPENDENT
          key: 'shelly.switch.output[{$SHELLY_SWITCH}]'
          description: 'Power status'
          valuemap:
            name: 'Power status'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.body[''{$SHELLY_TYPE}:{$SHELLY_SWITCH_ID}''].output'
              error_handler: DISCARD_VALUE
            - type: BOOL_TO_DECIMAL
          master_item:
            key: Shelly.GetStatus
          tags:
            - tag: component
              value: switch
            - tag: device
              value: shelly
        - uuid: eb544693184d4d7e9f42f1fa8fdddfb1
          name: Temperature
          type: DEPENDENT
          key: 'shelly.switch.temperature[{$SHELLY_SWITCH}]'
          value_type: FLOAT
          units: 'Â° C'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.body[''{$SHELLY_TYPE}:{$SHELLY_SWITCH_ID}''].temperature.tC'
              error_handler: DISCARD_VALUE
          master_item:
            key: Shelly.GetStatus
          tags:
            - tag: component
              value: switch
            - tag: device
              value: shelly
        - uuid: b80f163033da4fea881f0fa21a716bf0
          name: Voltage
          type: DEPENDENT
          key: 'shelly.switch.voltage[{$SHELLY_SWITCH}]'
          value_type: FLOAT
          units: V
          description: 'Last measured voltage in Volts'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.body[''{$SHELLY_TYPE}:{$SHELLY_SWITCH_ID}''].voltage'
              error_handler: DISCARD_VALUE
          master_item:
            key: Shelly.GetStatus
          tags:
            - tag: component
              value: switch
            - tag: device
              value: shelly
        - uuid: 760cc8fd8bc94bfd8e76daed97c9f257
          name: 'MAC address'
          type: DEPENDENT
          key: shelly.sys.mac
          value_type: TEXT
          description: 'Device MAC address'
          inventory_link: MACADDRESS_A
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.body.sys.mac
          master_item:
            key: Shelly.GetStatus
          tags:
            - tag: device
              value: shelly
        - uuid: dbedce478bda4bf59d4c9c7166d9359e
          name: 'Shelly avaiable update'
          type: DEPENDENT
          key: shelly.update.avaiable
          value_type: TEXT
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.body.stable.version
              error_handler: CUSTOM_VALUE
              error_handler_params: none
          master_item:
            key: Shelly.CheckForUpdate
          tags:
            - tag: component
              value: switch
            - tag: device
              value: shelly
          triggers:
            - uuid: c138365b6753452db1941970ec2a9a68
              expression: 'last(/Shelly Plug by HTTP/shelly.update.avaiable)<>"none"'
              name: 'New update available'
              url: 'http://{$SHELLY_HOST}'
              priority: INFO
              dependencies:
                - name: 'Host is down'
                  expression: 'last(/Shelly Plug by HTTP/net.tcp.service[http,,80])=0'
              tags:
                - tag: component
                  value: switch
                - tag: device
                  value: shelly
        - uuid: 2181c701cd7c4a7f8fd40c5dad64a905
          name: 'WiFi RSSI'
          type: DEPENDENT
          key: shelly.wifi.rssi
          value_type: FLOAT
          units: dBm
          description: 'WiFi signal strength in dBm'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.body.wifi.rssi
          master_item:
            key: Shelly.GetStatus
          tags:
            - tag: device
              value: shelly
          triggers:
            - uuid: 9bd488d9e48849c58e6be19557e8886f
              expression: 'last(/Shelly Plug by HTTP/shelly.wifi.rssi)<{$SHELLY_WIFI_RSSI_WARN}'
              name: 'WiFi RSSI low'
              opdata: 'Current value: {ITEM.LASTVALUE1} dBm'
              priority: WARNING
              manual_close: 'YES'
              dependencies:
                - name: 'Host is down'
                  expression: 'last(/Shelly Plug by HTTP/net.tcp.service[http,,80])=0'
              tags:
                - tag: device
                  value: shelly
        - uuid: d850501bdd3a47839b6cbd39cc029e5c
          name: 'WiFi SSID'
          type: DEPENDENT
          key: shelly.wifi.ssid
          value_type: TEXT
          description: 'Connected WiFi network SSID'
          inventory_link: HOST_NETWORKS
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.body.wifi.ssid
          master_item:
            key: Shelly.GetStatus
          tags:
            - tag: device
              value: shelly
        - uuid: c7c1e0e49d7c40fcaf4afc959f3902af
          name: 'WiFi IP address'
          type: DEPENDENT
          key: shelly.wifi.sta_ip
          value_type: TEXT
          description: 'Current WiFi IP address'
          inventory_link: OOB_IP
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.body.wifi.sta_ip
          master_item:
            key: Shelly.GetStatus
          tags:
            - tag: device
              value: shelly
      tags:
        - tag: class
          value: hardware
        - tag: target
          value: shelly
      macros:
        - macro: '{$SHELLY_HOST}'
          value: localhost
          description: 'Shelly network hostname or IP address'
        - macro: '{$SHELLY_MQTT_ENABLED}'
          value: '0'
          description: 'Set to 0 or 1 to check MQTT connection state'
        - macro: '{$SHELLY_PASS}'
          type: SECRET_TEXT
          description: 'Shelly password'
        - macro: '{$SHELLY_SWITCH_ID}'
          value: '0'
          description: 'Shelly switch/cover ID (usually does not need to be changed)'
        - macro: '{$SHELLY_TYPE}'
          value: switch
          description: 'Shelly device type (e.g., ''switch'' for plugs, ''cover'' for 2PM, ''pm1'' for PM Mini, etc.)'
        - macro: '{$SHELLY_USER}'
          value: admin
          description: 'Shelly username (usually does not need to be changed)'
        - macro: '{$SHELLY_WIFI_RSSI_WARN}'
          value: '-70'
          description: 'Minimum WiFi RSSI signal strength'
      valuemaps:
        - uuid: 2de8ec9fe66f45139688156325e2585c
          name: Boolean
          mappings:
            - value: '1'
              newvalue: 'true'
            - value: '0'
              newvalue: 'false'
        - uuid: d8ee1422107a41f3b3f8e4b4d39b3bfb
          name: 'Power status'
          mappings:
            - value: '1'
              newvalue: 'On'
            - value: '0'
              newvalue: 'Off'
        - uuid: d275f91c18bd45f3a805f3065f708c9c
          name: 'Service state'
          mappings:
            - value: '0'
              newvalue: Down
            - value: '1'
              newvalue: Up
